# USER: Defines which Linux user the NGINX worker processes run as.
# NEEDED: For security, we don't want it running as root. 'www-data' is the standard web user.
user www-data;

# WORKER_PROCESSES: How many background processes to spawn.
# NEEDED: 'auto' adapts to the number of CPU cores, ensuring performance without manual tuning.
worker_processes auto;

# PID: Where to store the Process ID file.
# NEEDED: NGINX uses this to track its own running process (e.g., for stop/reload commands).
pid /run/nginx.pid;

# EVENTS BLOCK: Configures how NGINX handles network connections.
# NEEDED: NGINX will not start without this block.
events {
	# WORKER_CONNECTIONS: Max simultaneous connections per worker.
	# NEEDED: 768 is a standard default. Too low = users get rejected.
	worker_connections 768;
}

# HTTP BLOCK: The context for all web-related settings.
# NEEDED: The 'server' directive IS NOT ALLOWED outside this block (this caused your error).
http {

	##
	# Basic Settings
	##

	# SENDFILE: Optimizes file transfer speed by copying data directly in the kernel.
	# NEEDED: Essential for performance when serving static files.
	sendfile on;

	# TCP_NOPUSH: Optimizes TCP packet sending (works with sendfile).
	# NEEDED: Helps reduce network overhead for large files.
	tcp_nopush on;

	# TCP_NODELAY: Disables Nagle's algorithm.
	# NEEDED: Ensures data is sent immediately without waiting to fill a packet (good for SSL).
	tcp_nodelay on;

	# KEEPALIVE_TIMEOUT: How long to keep a connection open.
	# NEEDED: Prevents the client from having to reconnect for every single image/css file.
	keepalive_timeout 65;

	# TYPES_HASH_MAX_SIZE: Memory allocated for MIME types.
	# NEEDED: Prevents startup errors if the MIME type table is large.
	types_hash_max_size 2048;

	# MIME TYPES: Loads the mapping of file extensions to content types (e.g., .html -> text/html).
	# NEEDED: Without this, browsers won't know how to render the files (CSS breaks, etc.).
	include /etc/nginx/mime.types;

	# DEFAULT_TYPE: Fallback content type if the file extension is unknown.
	# NEEDED: Ensures the browser downloads unknown binary files instead of trying to read them as text.
	default_type application/octet-stream;

	##
	# SSL Settings
	##

	# SSL_PROTOCOLS: Enforce specific secure versions.
	# NEEDED: Subject Requirement. Must be TLSv1.2 or TLSv1.3 only.
	ssl_protocols TLSv1.2 TLSv1.3;

	# SSL_PREFER_SERVER_CIPHERS: Use server's preferred ciphers over client's.
	# NEEDED: Improves security by ensuring strong encryption algorithms are used.
	ssl_prefer_server_ciphers on;

	##
	# Logging Settings
	##

	# ACCESS_LOG: Records every request.
	# NEEDED: Essential for debugging (seeing 404s, 500s) and audit.
	access_log /var/log/nginx/access.log;

	# ERROR_LOG: Records server errors.
	# NEEDED: Critical for knowing why the server crashed or failed to start.
	error_log /var/log/nginx/error.log;

	##
	# Virtual Host Configuration (Your Site)
	##

	server {
		# LISTEN: Port to accept connections on.
		# NEEDED: Subject Requirement. Must listen on 443 (HTTPS).
		listen 443 ssl;
		listen [::]:443 ssl;
		
		ssl_protocols TLSv1.2 TLSv1.3; # Required protocols (mentioned in pdf)
		ssl_certificates /etc/nginx/ssl/nchok.crt;
		ssl_certificates_key /etc/nginx/ssl/nchok.key;

		root /var/www/html; # Same volume as WordPress
		server_name nchok.42.fr; # Domain
		index index.php index.html index.htm;

		location / {
			try_files &uri &uri/ =404;
		}

		# Handle PHP files - Send them to WordPress Container
		location ~ \.php$ {
			include fastcgi_params;
			fastcgi_pass wordpress:9000; # Name of the WP service in docker-compose
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			include fastcgi_params;
		}
	}
}