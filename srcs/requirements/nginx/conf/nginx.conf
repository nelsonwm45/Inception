# USER: Defines which Linux user the NGINX worker processes run as.
# NEEDED: Security standard. We don't want the web server running as root.
user www-data;

# WORKER_PROCESSES: How many background processes to spawn.
# NEEDED: 'auto' lets NGINX adapt to the CPU cores available on the host VM.
worker_processes auto;

# PID: Location of the process ID file.
# NEEDED: Essential for NGINX to track its own running process (for stops/restarts).
pid /run/nginx.pid;

# EVENTS BLOCK: Configures network connection handling.
# NEEDED: MANDATORY. NGINX will fail to start without this block.
events {
    # WORKER_CONNECTIONS: Max simultaneous connections per worker.
    # NEEDED: 768 is a safe default. If too low, the server drops connections.
    worker_connections 768;
}

# HTTP BLOCK: The context for all web settings.
# NEEDED: MANDATORY. The 'server' directive is ONLY allowed inside this block.
http {
    
    # SSL Settings - REQUIRED by Subject
    # NEEDED: To enable secure connections.
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # MIME Types
    # NEEDED: Tells the browser if a file is HTML, CSS, or an Image.
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # LOGS
    # NEEDED: For debugging errors (like the one you just had) and tracking access.
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # SERVER BLOCK: Defines your specific website.
    # NEEDED: This is where we configure port 443 and the domain name.
    server {
        # LISTEN: Port 443 for HTTPS.
        # NEEDED: Subject requirement (HTTPS only).
        listen 443 ssl;
        listen [::]:443 ssl;

        # SERVER_NAME: Your domain.
        # NEEDED: Tells NGINX to respond to requests for 'nchok.42.fr'.
        server_name nchok.42.fr;

        # SSL CERTIFICATES:
        # NEEDED: The path to the certs you generated in the Dockerfile.
        ssl_certificate /etc/nginx/ssl/nchok.crt;
        ssl_certificate_key /etc/nginx/ssl/nchok.key;

        # ROOT: Where the WordPress files are.
        # NEEDED: NGINX needs to know where to look for index.php.
        root /var/www/html;
        
        # INDEX: Default files to serve.
        # NEEDED: Tells NGINX to load index.php by default.
        index index.php index.html index.htm;

        # LOCATION /: Standard WordPress routing.
        # NEEDED: Handles permalinks correctly.
        location / {
            try_files $uri $uri/ /index.php$is_args$args;
        }

        # LOCATION PHP: Passing PHP to WordPress container.
        # NEEDED: NGINX cannot run PHP. It proxies it to the 'wordpress' container.
        location ~ \.php$ {
            include snippets/fastcgi-php.conf;
            # 'wordpress' is the container name defined in docker-compose.yml
            fastcgi_pass wordpress:9000;
        }
    }
}