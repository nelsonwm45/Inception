FROM debian:bullseye

# 1. Basic system setup
RUN apt-get update && \
	apt-get install -y \
		nginx \
		openssl \
		ca-certificates && \
	rm -rf /var/lib/apt/lists/*

# 2. Create directories for certs and web files
RUN mkdir -p /etc/nginx/ssl	/var/www/html

# 3) Copy your NGINX config and TLS certs (self-signed in dev)
#    - nginx.conf will:
#         * listen 443 ssl http2;
#         * use ssl_protocols TLSv1.2 TLSv1.3;
#         * proxy_pass to wordpress:9000 (php-fpm via fastcgi);
COPY conf/nginx.conf /etc/nginx/nginx.conf
COPY conf/default.conf /etc/nginx/conf.d/default.conf


# Optional: copy your cert/key generated by a script in tools/
# In practice youâ€™d generate them in an entrypoint script if not present.
COPY conf/ssl/server.crt /etc/nginx/ssl/server.crt
COPY conf/ssl/server.key /etc/nginx/ssl/server.key

# 4) Set proper permissions (very important for certs)
RUN chmod 600 /etc/nginx/ssl/server.key && \
    chmod 644 /etc/nginx/ssl/server.crt && \
    chown -R www-data:www-data /var/www/html

# 5) NGINX runs as www-data by default, so we keep root for PID 1
#    but worker processes run as www-data (set in nginx.conf)

# 6) Expose ONLY 443 (evaluation: "NGINX can be accessed by port 443 only")
EXPOSE 443

# 7) Run nginx in the foreground (PID 1) - No infinite loop, no tail -f, no while true
CMD ["nginx", "-g", "daemon off;"]